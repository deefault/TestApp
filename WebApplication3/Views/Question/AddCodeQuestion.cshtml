@using Microsoft.AspNetCore.Mvc
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.AspNetCore.Routing
@model WebApplication3.Models.QuestionViewModels.AddCodeQuestionViewModel

@{
    ViewBag.Title = "Добавить вопрос";
    Layout = "_Layout";
}



<div class="container">
    <link rel="stylesheet" href="~/lib/codemirror/theme/material.css" />
    <link rel="stylesheet" href="~/lib/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="~/lib/codemirror/addon/fold/foldgutter.css" />
    <link rel="stylesheet" href="~/lib/codemirror/addon/hint/show-hint.css" />
    <link rel="stylesheet" href="~/lib/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.css" />
    <div class="form-group" id="fields">
        <div class="">
            <form asp-controller="Question" asp-action="AddCodeQuestion" asp-route-returnurl="/User/Tests/@ViewContext.RouteData.Values["testId"]" method="post" class="form" role="form" autocomplete="off">
                <hr />
                <h4 class="text-center">Добавить вопрос на написание кода</h4>
                <hr />
                <ul class="text-danger" id="validation-summary"></ul>
                @*<div asp-validation-summary="All" class="text-danger"></div>*@
                <b>Текст вопроса:</b>
                <div>
                    @*<label asp-for="Title" class="col-md-2 col-lg-2"></label>*@
                    <div class="form-group clearfix contentwrapper">
                        <textarea asp-for="Title" class="form-control"></textarea>
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>
                </div>
                <b>Балл:</b>
                <div>
                    <div class="form-group clearfix contentwrapper">
                        <input id="score" asp-for="Score" type="text" class="form-control" placeholder="1..100" min="1" max="100" />
                        <span asp-validation-for="Score" class="text-danger"></span>
                    </div>
                </div>
                <div class="main">
                    <div class="form-group clearfix contentwrapper" id="item-table__body">
                        <textarea class="form-control" id="code">
using System;

namespace TestsApp
{
    public class Program
    {
        public string Main(string message)
        {
            return message;
        }
    }
}</textarea>
                        <span class="aside">
                            <em><b>Ctrl-Space</b>: autocomplete</em>
                        </span>
                    </div>

                    <div>
                        <b>Аргументы:</b>
                        <div class="input-group">
                            <input id="args" value="Hello World" class="form-control">
                            <span class="input-group-append">
                                <button class="btn btn-success" id="compile">Запуск</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div id="formDiv">
                    <div>
                        <b>Вывод:</b>
                        <pre id="output" class="form-control" readonly=""></pre>
                    </div>
                </div>
                <input type="hidden" value="@ViewContext.RouteData.Values["testId"]" asp-for="TestId" />

                <div class="form-group row">
                    <div class="col-md-offset-2 col-md-10">
                        <button type="submit" class="btn btn-primary">Добавить</button>
                    </div>
                </div>
            </form>
            <br>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/lib/codemirror/lib/codemirror.js"></script>
    <script src="~/lib/codemirror/mode/clike/clike.js"></script>
    <script src="~/lib/codemirror/mode/python/python.js"></script>
    <script src="~/lib/codemirror/keymap/sublime.js"></script>
    <script src="~/lib/codemirror/addon/fold/foldcode.js"></script>
    <script src="~/lib/codemirror/addon/fold/foldgutter.js"></script>
    <script src="~/lib/codemirror/addon/fold/brace-fold.js"></script>
    <script src="~/lib/codemirror/addon/fold/comment-fold.js"></script>
    <script src="~/lib/codemirror/addon/edit/closebrackets.js"></script>
    <script src="~/lib/codemirror/addon/edit/trailingspace.js"></script>
    <script src="~/lib/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="~/lib/codemirror/addon/hint/anyword-hint.js"></script>
    <script src="~/lib/codemirror/addon/hint/show-hint.js"></script>
    <script src="~/lib/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.js"></script>
    <script async>
        $("#score").TouchSpin({
            verticalbuttons: true,
        });
        var elements =
        {
            args: $("#args"),
            compile: $("#compile"),
            output: $("#output"),
            code: $("#code"),
        };
        // Editor Objects
        var editor = CodeMirror.fromTextArea(document.getElementById('code'),
            {
                lineNumbers: true,
                mode: "text/x-csharp",
                theme: "material",
                autoCloseBrackets: true,
                matchBrackets: true,
                showCursorWhenSelecting: true,
                indentUnit: 4,
                tabSize: 4,
                keyMap: "sublime",
                rulers: [{ column: 80, lineStyle: "dashed" }],
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: { "Ctrl-Space": "autocomplete" }
            });
        elements.compile.click(function (e) {
            e.preventDefault();
            ShowOutput("Waiting for server...");
            Compile();
        });
        $(".CodeMirror").addClass("contentwrapper");
        function ShowOutput(output) {
            elements.output.html(output);
        }
        function ShowSuccess(reply) {
            console.log("OUTPUT: " + reply);
            ShowOutput(reply);
        }
        function ShowError(err) {
            console.error(err);
            ShowOutput(err);
        }
        function Compile() {
            submitCode();
            loadCode();
        }
    </script>
    <script>
        loadCode();
        function submitCode() {
            var data = {};
            data.Value = editor.getValue();
            data.Args = elements.args.val();
            var actionUrl = "/Code/";
            console.log(data);
            // запрос
            $.ajax({
                async: false,
                method: "POST",
                url: actionUrl,
                beforeSend: function (xhr) {
                    $("#output").html("Waiting for server...");
                    xhr.setRequestHeader("RequestVerificationToken",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },
                contentType: "application/json",
                data: JSON.stringify(data),
                success: function (response) {
                    console.log(response);
                },
                error: function (xhr, textStatus, errorThrown) {
                    //console.log(textStatus + ": Couldn't add control. " + errorThrown);
                    console.log(xhr);
                },
            });
        }
        function loadCode() {
            var actionUrl = "/Code/";
            $.ajax({
                async: false,
                cache: false,
                method: "GET",
                url: actionUrl,
                dataType: "html",
                beforeSend: function () {

                },
                success: function (response) {
                    //заменить html код формой внутри div
                    $("#formDiv").html(response);
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log(xhr.responseJSON);
                }
            });
        }
    </script>
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
}

