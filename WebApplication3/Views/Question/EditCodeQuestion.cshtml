@using Microsoft.AspNetCore.Mvc
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.AspNetCore.Routing
@model WebApplication3.Models.CodeQuestion
@{
    ViewBag.Title = "Добавить вопрос";
    Layout = "_Layout";
}

<div class="container">
    <link rel="stylesheet" href="~/lib/codemirror/theme/material.css" />
    <link rel="stylesheet" href="~/lib/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" href="~/lib/codemirror/addon/fold/foldgutter.css" />
    <link rel="stylesheet" href="~/lib/codemirror/addon/hint/show-hint.css" />
    <link rel="stylesheet" href="~/lib/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.css" />
    <div class="form-group" id="fields">
        <div class="">
            <form asp-controller="Question" asp-action="EditCodeQuestion" asp-route-returnurl="/User/Tests/@ViewContext.RouteData.Values["testId"]" method="post" class="form" role="form" autocomplete="off">
                <hr />
                <h4 class="text-center">Изменить вопрос на написание кода</h4>
                <hr />
                <ul class="text-danger" id="validation-summary"></ul>
                @*<div asp-validation-summary="All" class="text-danger"></div>*@
                <b>Текст вопроса:</b>
                <div>
                    @*<label asp-for="Title" class="col-md-2 col-lg-2"></label>*@
                    <div class="form-group clearfix contentwrapper">
                        <textarea asp-for="Title" class="form-control"></textarea>
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>
                </div>
                <b>Балл:</b>
                <div>
                    <div class="form-group clearfix contentwrapper">
                        <input id="score" asp-for="Score" type="text" class="form-control" placeholder="1..100" min="1" max="100" />
                        <span asp-validation-for="Score" class="text-danger"></span>
                    </div>
                </div>
                <div class="main">
                    <div class="form-group clearfix contentwrapper" id="item-table__body">
                        <textarea class="form-control" id="code">
@Model.Code.Value</textarea>
                        <span class="aside">
                            <em><b>Ctrl-Space</b>: autocomplete</em>
                        </span>
                    </div>
                    <div style="margin-bottom: 1rem">
                        <b>Аргументы:</b>
                        <div class="input-group">
                            <input id="args" value="@Model.Code.Args" class="form-control">
                            <span class="input-group-append">
                                <button class="btn btn-success" id="compile">Запуск</button>
                            </span>
                        </div>
                        <span class="aside">
                            <em>Use <b>;</b> to separate multiple</em>
                        </span>
                    </div>
                </div>
                <div id="outputDiv">
                    <div>
                        <b>Вывод:</b>
                        <pre id="output" class="form-control" readonly="">@Model.Code.Output</pre>
                    </div>
                </div>
                <input type="hidden" value="@ViewContext.RouteData.Values["testId"]" asp-for="Test.Id" />
                <div class="form-group row">
                    <div class="col-md-offset-2 col-md-10">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </div>
            </form>
            <br>
        </div>
    </div>
</div>
@section Scripts {
    <script src="~/lib/codemirror/lib/codemirror.js"></script>
    <script src="~/lib/codemirror/mode/clike/clike.js"></script>
    <script src="~/lib/codemirror/mode/python/python.js"></script>
    <script src="~/lib/codemirror/keymap/sublime.js"></script>
    <script src="~/lib/codemirror/addon/fold/foldcode.js"></script>
    <script src="~/lib/codemirror/addon/fold/foldgutter.js"></script>
    <script src="~/lib/codemirror/addon/fold/brace-fold.js"></script>
    <script src="~/lib/codemirror/addon/fold/comment-fold.js"></script>
    <script src="~/lib/codemirror/addon/edit/closebrackets.js"></script>
    <script src="~/lib/codemirror/addon/edit/trailingspace.js"></script>
    <script src="~/lib/codemirror/addon/edit/matchbrackets.js"></script>
    <script src="~/lib/codemirror/addon/hint/anyword-hint.js"></script>
    <script src="~/lib/codemirror/addon/hint/show-hint.js"></script>
    <script src="~/lib/codemirror/addon/selection/active-line.js"></script>
    <script src="~/lib/bootstrap-touchspin/src/jquery.bootstrap-touchspin.js"></script>
    <script>
        $("#score").TouchSpin({
            verticalbuttons: true,
        });
        @*loadOutput('@Url.RouteUrl("EditGetCode", new {testId = Context.GetRouteData().Values["testId"], questionId = Model.Id })');*@
        var elements =
        {
            args: $("#args"),
            compile: $("#compile"),
            output: $("#output"),
            code: $("#code"),
        };
        var editor = CodeMirror.fromTextArea(document.getElementById('code'),
            {
                lineNumbers: true,
                mode: "text/x-csharp",
                theme: "material",
                autoCloseBrackets: true,
                matchBrackets: true,
                styleActiveLine: true,
                styleActiveSelected: true,
                showCursorWhenSelecting: true,
                indentUnit: 4,
                tabSize: 4,
                keyMap: "sublime",
                rulers: [{ column: 80, lineStyle: "dashed" }],
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: { "Ctrl-Space": "autocomplete" }
            });
        elements.compile.click(function (e) {
            e.preventDefault();
            ShowOutput("Waiting for server...");
            Compile();
        });
        $(".CodeMirror").addClass("contentwrapper");
        function ShowOutput(output) {
            $("#output").html(output);
        }
        function Compile() {
            submitCode('@Url.RouteUrl("EditPostCode", new {testId = Context.GetRouteData().Values["testId"], questionId = Model.Id })');
            loadOutput('@Url.RouteUrl("EditGetCode", new {testId = Context.GetRouteData().Values["testId"], questionId = Model.Id })');
        }

        $("form").submit(function(event) {
            event.preventDefault();
            submitCodeQuestion('@Url.RouteUrl("EditCode", new {testId = Context.GetRouteData().Values["testId"], questionId = Model.Id })');

        });
    </script>
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
}
